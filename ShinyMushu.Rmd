---
title: "ShinyMushu"
author: "Laura Ingulsrud, Sidney Gerst, Natalie Dornan"
date: "2/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

library(tidyverse)
library(janitor)
library(lubridate)
library(stringr)
library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(raster)
library(rgdal)
library(sp)


select <- dplyr::select

```

```{r data}

HAB <- read_csv("HAB.csv") # Read in data: "Harmful Algal Blooms 2008-2019"

# Clean up the data
clean_hab <- HAB %>% 
  clean_names(., case = c("snake")) %>% # Convert to snake case
  select(year, month, day, latitude, longitude, location, akashiwo_sanguinea_cells_l, alexandrium_spp_cells_l, ammonia_u_m, chlorophyll_mg_m3, domoic_acid_ng_m_l, nitrate_u_m, nitrite_u_m, phosphate_u_m, pseudo_nitzschia_delicatissima_group_cells_l, pseudo_nitzschia_seriata_group_cells_l, silicate_u_m, water_temperature_c) %>% # Selected species that are correlated with HABs
  na.omit() %>% # Remove "NaNs" 
  rename(akashiwo = akashiwo_sanguinea_cells_l,
         alexandrium = alexandrium_spp_cells_l,
         ammonia = ammonia_u_m,
         chlorophyll = chlorophyll_mg_m3,
         domoic_acid = domoic_acid_ng_m_l,
         nitrate = nitrate_u_m,
         nitrite = nitrite_u_m,
         phosphate = phosphate_u_m,
         pseudo_nitzschia_delicatissima = pseudo_nitzschia_delicatissima_group_cells_l,
         pseudo_nitzschia_seriata = pseudo_nitzschia_seriata_group_cells_l,
         silicate = silicate_u_m,
         water_temp = water_temperature_c) %>% # Rename variables
  mutate(year_month = str_c(year, month, sep = "-")) %>% # Create one column of year and month of sample together
  mutate("n_n" = nitrate + nitrite) %>%
  mutate(pseudo_nitzschia_spp = pseudo_nitzschia_delicatissima + pseudo_nitzschia_seriata)## sum N+N concentrations


```

```{r LAURA - Tab 2: HAB abundance chart}

chlorophyll_col <- ggplot(clean_hab, aes(x = month, y = chlorophyll)) +
  geom_col(fill = "seagreen3", color = "seagreen") +
  labs(x = "Month", y = "Chlorophyll Concentration (mg/L)") +
  theme_bw() 

chlorophyll_col

domoic_col <- ggplot(clean_hab, aes(x = month, y = domoic_acid)) +
  geom_col(fill = "cornflowerblue", color = "royalblue") +
  labs(x = "Month", y = "Domoic Acid Concentration (mg/L)") +
  theme_bw() 

domoic_col

##laura was this across all years? really interesting stuff. Chl a is highest in May but domoic acid is highest in April! 

```

```{r NATALIE - Tab 3: Correlation plot}

## Set the purpose: To create a friendly widget that will allow users to explore abiotic and biotic relationships relating to HAB occurence. ex)

hab_cor <- clean_hab %>%
  select(year_month, location, akashiwo, alexandrium, ammonia, chlorophyll, domoic_acid, n_n, phosphate, silicate,     water_temp)

##model_name <- lm(y_variable ~ x_variable, data = df_name)

temp_lm <- lm(chlorophyll ~ water_temp, data = hab_cor)

summary(temp_lm)

ggplot(hab_cor, aes(x = water_temp, y = chlorophyll)) +
  geom_point() +  
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(temp_lm)$adj.r.squared, 5),
                     "Intercept =",signif(temp_lm$coef[[1]],5 ),
                     " Slope =",signif(temp_lm$coef[[2]], 5),
                     " P =",signif(summary(temp_lm)$coef[2,4], 5)))

#####

n_lm <- lm(chlorophyll ~ n_n, data = hab_cor)

summary(n_lm)

ggplot(hab_cor, aes(x = n_n, y = chlorophyll)) +
  geom_point() +  
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(n_lm)$adj.r.squared, 5),
                     "Intercept =",signif(n_lm$coef[[1]],5 ),
                     " Slope =",signif(n_lm$coef[[2]], 5),
                     " P =",signif(summary(n_lm)$coef[2,4], 5)))

######

domoic_lm <- lm(chlorophyll ~ domoic_acid, data = hab_cor)

summary(domoic_lm)

ggplot(hab_cor, aes(x = domoic_acid, y = chlorophyll)) +
  geom_point() +  
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(domoic_lm)$adj.r.squared, 5),
                     "Intercept =",signif(domoic_lm$coef[[1]],5 ),
                     " Slope =",signif(domoic_lm$coef[[2]], 5),
                     " P =",signif(summary(domoic_lm)$coef[2,4], 5)))
######

d_n_lm <- lm(domoic_acid ~ n_n, data = hab_cor)

summary(d_n_lm)

ggplot(hab_cor, aes(x = n_n, y = domoic_acid)) +
  geom_point() +  
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(d_n_lm)$adj.r.squared, 5),
                     "Intercept =",signif(d_n_lm$coef[[1]],5 ),
                     " Slope =",signif(d_n_lm$coef[[2]], 5),
                     " P =",signif(summary(d_n_lm)$coef[2,4], 5)))

```























```{r SIDNEY - Tab 4: Interactive Map}

#create a map of california 
ca_counties <- read_sf(".", layer = "california_county_shape_file")

View(ca_counties)

#this time give the projection
st_crs(ca_counties) = 4326

bounds <- as(extent(-125.5, -116.5, 31.7, 37.4), 'SpatialPolygons')

#make the bounds polygon have wgs84
crs(bounds) <- crs(ca_counties)

#look at sst in our bounds
ca_crop <- gintersection(ca_counties, bounds, byid = TRUE)
ca_crop <- crop(ca_counties, bounds)
plot(ca_crop)

coast_counties <- ca_counties %>%
  dplyr::filter(NAME == c("San Luis Obispo", "Santa Barbara", "Ventura", "Los Angeles", "Orange", "San Diego"))

plot(coast_counties)

str(clean_hab)

hab_sp <- st_as_sf(clean_hab, coords = c("latitude", "longitude"))

st_crs(hab_sp) = 4326



hab_ammonia <- hab_sp %>%
  select(ammonia)

ggplot(coast_counties) +
  geom_sf(data = coast_counties, 
          fill = "gray80",
          color = "gray30",
          size = 0.1) +
  geom_point(data = clean_hab,
             aes(x = longitude, y = latitude),
             size = 1,
             color = "gray10",
             alpha = 0.5) +
  theme_minimal()+
  coord_sf(datum = NA)

plot(hab_ammonia)

View(hab_sp)

```

